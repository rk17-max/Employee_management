<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRMS Lite Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        body { padding: 20px; }
        .grid-header { display: flex; justify-content: space-between; align-items: center; }
        .status-present { color: #2ecc71; font-weight: bold; }
        .status-absent { color: #e74c3c; font-weight: bold; }
        .stat-card { text-align: center; padding: 20px; background: #f4f6f8; border-radius: 8px; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #1095c1; }
        .hidden { display: none; }
        .error-msg { color: #d93545; margin-bottom: 10px; }
    </style>
</head>
<body>
    <main class="container">
        <div class="grid-header">
            <h1>HRMS Lite Dashboard</h1>
            <small>Admin Portal</small>
        </div>
        <hr>

        <div class="grid">
            <div class="stat-card">
                <div>Total Employees</div>
                <div class="stat-number" id="totalEmpCount">-</div>
            </div>
            <div class="stat-card">
                <div>Present Today</div>
                <div class="stat-number" id="presentTodayCount">-</div>
            </div>
        </div>
        <br>

        <article>
            <header><strong>Add New Employee</strong></header>
            <div id="addError" class="error-msg"></div>
            <form id="addForm">
                <div class="grid">
                    <input type="text" id="empId" placeholder="Employee ID (Unique)" required>
                    <input type="text" id="name" placeholder="Full Name" required>
                </div>
                <div class="grid">
                    <input type="email" id="email" placeholder="Email Address" required>
                    <input type="text" id="dept" placeholder="Department" required>
                </div>
                <button type="submit">Add Employee</button>
            </form>
        </article>

        <article>
            <header><strong>Employee Directory</strong></header>
            <figure>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Dept</th>
                            <th>Total Present</th> <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="empTable">
                        <tr><td colspan="5" aria-busy="true">Loading...</td></tr>
                    </tbody>
                </table>
            </figure>
        </article>

        <dialog id="attendanceModal">
            <article>
                <header>
                    <a href="#close" aria-label="Close" class="close" onclick="closeModal()"></a>
                    <strong>Attendance: <span id="modalEmpName"></span></strong>
                </header>
                
                <form id="attForm">
                    <div class="grid">
                        <input type="date" id="attDate" required>
                        <select id="attStatus">
                            <option value="Present">Present</option>
                            <option value="Absent">Absent</option>
                        </select>
                    </div>
                    <button type="submit">Mark Attendance</button>
                </form>

                <hr>
                
                <div class="grid">
                    <strong>History</strong>
                    <input type="date" id="filterDate" onchange="filterHistory()" placeholder="Filter by Date">
                </div>

                <table role="grid">
                    <tbody id="attHistory"></tbody>
                </table>
            </article>
        </dialog>
    </main>

    <script>
        const API_URL = '/api';

        // Load Dashboard & Employees
        async function loadDashboard() {
            // Fetch Stats
            const statsRes = await fetch(`${API_URL}/dashboard`);
            const stats = await statsRes.json();
            document.getElementById('totalEmpCount').innerText = stats.total_employees;
            document.getElementById('presentTodayCount').innerText = stats.present_today;

            // Fetch Employees
            const empRes = await fetch(`${API_URL}/employees`);
            const employees = await empRes.json();
            const tbody = document.getElementById('empTable');
            tbody.innerHTML = '';

            if (employees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No employees found.</td></tr>';
                return;
            }

            employees.forEach(emp => {
                tbody.innerHTML += `
                    <tr>
                        <td>${emp.employee_id}</td>
                        <td>${emp.name}</td>
                        <td>${emp.department}</td>
                        <td><strong>${emp.total_present}</strong> days</td>
                        <td>
                            <button class="contrast outline" style="width:auto; padding:5px 10px; display:inline-block;" onclick="openModal('${emp.employee_id}', '${emp.name}')">üìÖ</button>
                            <button class="secondary outline" style="width:auto; padding:5px 10px; display:inline-block;" onclick="deleteEmp('${emp.employee_id}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        }
        
        loadDashboard();

        // Add Employee
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                employee_id: document.getElementById('empId').value,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                department: document.getElementById('dept').value
            };
            const res = await fetch(`${API_URL}/employees`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                document.getElementById('addForm').reset();
                document.getElementById('addError').innerText = '';
                loadDashboard();
            } else {
                const err = await res.json();
                document.getElementById('addError').innerText = err.detail || "Error";
            }
        });

        // Delete Employee
        async function deleteEmp(id) {
            if(!confirm('Delete this employee?')) return;
            await fetch(`${API_URL}/employees/${id}`, { method: 'DELETE' });
            loadDashboard();
        }

        // Attendance Modal
        let currentEmpId = null;
        const modal = document.getElementById('attendanceModal');

        async function openModal(id, name) {
            currentEmpId = id;
            document.getElementById('modalEmpName').innerText = name;
            document.getElementById('attDate').valueAsDate = new Date();
            document.getElementById('filterDate').value = ''; // Reset filter
            modal.setAttribute('open', true);
            loadAttendanceHistory(id);
        }

        function closeModal() {
            modal.removeAttribute('open');
            loadDashboard(); // Refresh stats when closing
        }

        // Load History (with optional Date Filter)
        async function loadAttendanceHistory(id, dateFilter = '') {
            let url = `${API_URL}/attendance/${id}`;
            if (dateFilter) url += `?date=${dateFilter}`; // Append query param
            
            const res = await fetch(url);
            const data = await res.json();
            const tbody = document.getElementById('attHistory');
            
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td>No records found.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td class="${r.status === 'Present' ? 'status-present' : 'status-absent'}">${r.status}</td>
                </tr>
            `).join('');
        }

        // Filter Function
        function filterHistory() {
            const date = document.getElementById('filterDate').value;
            loadAttendanceHistory(currentEmpId, date);
        }

        // Mark Attendance
        document.getElementById('attForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await fetch(`${API_URL}/attendance`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    employee_id: currentEmpId,
                    date: document.getElementById('attDate').value,
                    status: document.getElementById('attStatus').value
                })
            });
            loadAttendanceHistory(currentEmpId);
        });
    </script>
</body>
</html>